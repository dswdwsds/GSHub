<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCOOP OPBR | Ø®Ø¯Ù…Ø© ØªØ·ÙˆÙŠØ± Ø¨ÙˆÙ†ØªÙŠ Ø±Ø§Ø´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Configuration ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1395038941110866010/MucgrT_399C44lfUVL79HcqR4cfwNbJlL5iG1qPmxdBF47GGbTbmkokZK6YnslmJ63wL";
        const VODAFONE_CASH_NUMBER = "010XXXXXXXX";

        // --- Data ---
        const CHARACTERS = [
            { id: "001", name: "Ù…ÙˆÙ†ÙƒÙŠ Ø¯ÙŠ Ù„ÙˆÙÙŠ", stars: 2, price: 30, img: "https://static.wikia.nocookie.net/onepiece/images/a/af/Luffy_Bounty_Rush.png" },
            { id: "002", name: "Ø±ÙˆØ±ÙˆÙ†ÙˆØ§ Ø²ÙˆØ±Ùˆ", stars: 2, price: 30, img: "https://static.wikia.nocookie.net/onepiece/images/b/b4/Zoro_Bounty_Rush.png" },
            { id: "EX1", name: "Ø¥ÙŠØ³ ÙˆÙŠØ§Ù…Ø§ØªÙˆ", stars: 4, price: 80, img: "https://static.wikia.nocookie.net/onepiece/images/f/f5/Ace_and_Yamato_Bounty_Rush.png" },
            { id: "EX2", name: "ØºÙˆÙ„ Ø¯ÙŠ Ø±ÙˆØ¬Ø±", stars: 4, price: 80, img: "https://static.wikia.nocookie.net/onepiece/images/b/b3/Gol_D._Roger_Bounty_Rush.png" },
            { id: "EX3", name: "Ø¥Ø³-Ø³Ù†ÙŠÙƒ", stars: 4, price: 80, img: "https://static.wikia.nocookie.net/onepiece/images/a/a6/S-Snake_Bounty_Rush.png" }
        ];

        let currentUser = null;
        let selectedChars = [];

        // --- App Logic ---
        window.initApp = async () => {
            // Auth Logic (Rule 3)
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth error:", err);
            }

            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) listenToOrders();
            });

            renderCharacters();
        };

        const renderCharacters = () => {
            const container = document.getElementById('char-grid');
            container.innerHTML = CHARACTERS.map(char => `
                <div onclick="toggleChar('${char.id}')" id="char-${char.id}" class="bg-slate-900 border-2 border-white/5 p-4 rounded-[2rem] cursor-pointer transition-all hover:border-white/20 group">
                    <div class="aspect-square bg-slate-800 rounded-2xl mb-4 overflow-hidden">
                        <img src="${char.img}" class="w-full h-full object-contain group-hover:scale-110 transition-transform">
                    </div>
                    <h3 class="font-black text-lg">${char.name}</h3>
                    <div class="flex justify-between mt-2">
                        <span class="text-xs text-slate-500">${char.stars} Ù†Ø¬ÙˆÙ…</span>
                        <span class="text-red-500 font-black">${char.price} Ø¬.Ù…</span>
                    </div>
                </div>
            `).join('');
        };

        window.toggleChar = (id) => {
            const char = CHARACTERS.find(c => c.id === id);
            const index = selectedChars.findIndex(c => c.id === id);
            const el = document.getElementById(`char-${id}`);

            if (index > -1) {
                selectedChars.splice(index, 1);
                el.classList.remove('border-red-600', 'bg-red-600/5');
            } else {
                selectedChars.push(char);
                el.classList.add('border-red-600', 'bg-red-600/5');
            }
            updateSummary();
        };

        const updateSummary = () => {
            const total = selectedChars.reduce((sum, c) => sum + c.price, 0);
            document.getElementById('total-price').innerText = total;
            document.getElementById('order-btn').disabled = selectedChars.length === 0 || !document.getElementById('phone-input').value;
        };

        window.submitOrder = async () => {
            if (!currentUser) return;
            const phone = document.getElementById('phone-input').value;
            const total = selectedChars.reduce((sum, c) => sum + c.price, 0);

            const orderData = {
                userId: currentUser.uid,
                phone,
                characters: selectedChars,
                totalPrice: total,
                status: 'pending',
                createdAt: serverTimestamp()
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), orderData);
                // Send Discord
                fetch(DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: `ğŸš€ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¨Ù‚ÙŠÙ…Ø© ${total} Ø¬.Ù… Ù…Ù† ${phone}` })
                });
            } catch (err) {
                console.error("Order error:", err);
            }
        };

        const listenToOrders = () => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), orderBy('createdAt', 'asc'));
            onSnapshot(q, (snap) => {
                const orders = snap.docs.map(d => ({id: d.id, ...d.data()}));
                const active = orders.filter(o => o.status !== 'completed');
                const myOrder = active.find(o => o.userId === currentUser.uid);
                
                if (myOrder) {
                    const pos = active.findIndex(o => o.userId === currentUser.uid) + 1;
                    showStatus(pos, myOrder.status);
                }
            });
        };

        const showStatus = (pos, status) => {
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('status-view').classList.remove('hidden');
            document.getElementById('queue-pos').innerText = pos;
        };

        window.onload = initApp;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; }
    </style>
</head>
<body class="bg-slate-950 text-white min-h-screen">
    <nav class="border-b border-white/5 p-6 bg-slate-900/50 backdrop-blur-lg sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-black text-red-600">SCOOP OPBR</h1>
            <div class="bg-red-600/10 text-red-500 px-4 py-1 rounded-full text-xs font-bold border border-red-500/20">Ø£Ø³Ø±Ø¹ ØªØ·ÙˆÙŠØ± ÙÙŠ Ù…ØµØ±</div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-6" id="main-view">
        <header class="py-16 text-center space-y-4">
            <h2 class="text-5xl font-black">Ø­ÙˆÙ„ Ø´Ø®ØµÙŠØ§ØªÙƒ Ø¥Ù„Ù‰ <span class="text-red-600">Ø£Ø³Ø·ÙˆØ±Ø©</span></h2>
            <p class="text-slate-400">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø®ØµÙŠØ§Øª ÙˆØ§Ø¯ÙØ¹ Ø¹Ø¨Ø± ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ Ù„ØªØ¨Ø¯Ø£ Ø§Ù„ØªØ·ÙˆÙŠØ± ÙÙˆØ±Ø§Ù‹</p>
        </header>

        <div class="grid lg:grid-cols-3 gap-10">
            <div class="lg:col-span-2">
                <div id="char-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- Characters injected here -->
                </div>
            </div>

            <aside class="space-y-6">
                <div class="bg-slate-900 p-8 rounded-[2.5rem] border border-white/10 sticky top-28">
                    <h3 class="text-xl font-black mb-6">Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h3>
                    <div class="flex justify-between items-center py-4 border-t border-white/5">
                        <span class="font-bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                        <span class="text-3xl font-black"><span id="total-price">0</span> Ø¬.Ù…</span>
                    </div>
                    <div class="space-y-4">
                        <input type="tel" id="phone-input" oninput="updateSummary()" placeholder="Ø±Ù‚Ù… ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ Ø§Ù„Ù…Ø±Ø³Ù„" 
                               class="w-full bg-slate-950 border border-white/10 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-red-600">
                        <button id="order-btn" onclick="submitOrder()" disabled 
                                class="w-full bg-red-600 hover:bg-red-700 disabled:opacity-50 py-4 rounded-2xl font-black transition-all">
                            ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø·Ø§Ø¨ÙˆØ±
                        </button>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <!-- Status View -->
    <div id="status-view" class="hidden max-w-2xl mx-auto text-center py-20 space-y-10">
        <div class="relative inline-block">
            <div class="w-48 h-48 rounded-full border-8 border-red-600/20 border-t-red-600 animate-spin mx-auto"></div>
            <div class="absolute inset-0 flex flex-col items-center justify-center">
                <span class="text-xs font-bold text-slate-500">ØªØ±ØªÙŠØ¨Ùƒ</span>
                <span id="queue-pos" class="text-6xl font-black">1</span>
            </div>
        </div>
        <h2 class="text-3xl font-black">Ø·Ù„Ø¨Ùƒ ÙÙŠ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°!</h2>
        <p class="text-slate-400">Ø³ÙŠØªÙ… Ø¥Ø®Ø·Ø§Ø±Ùƒ Ù‡Ù†Ø§ ÙÙˆØ± Ø§ÙƒØªÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ·ÙˆÙŠØ±.</p>
    </div>
</body>
</html>